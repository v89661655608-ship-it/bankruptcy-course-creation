import json
import base64
import io
from typing import Dict, Any
from datetime import datetime
from docx import Document
from docx.shared import Pt, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
try:
    from reportlab.lib.pagesizes import A4
    from reportlab.pdfgen import canvas
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont
    from reportlab.lib.units import cm
except ImportError:
    pass

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    '''
    Генерация заявления о признании гражданина банкротом на основе собранных данных
    
    Получает: персональные данные, кредитную историю, доходы, имущество
    Возвращает: сформированное заявление в формате DOCX/PDF
    '''
    method: str = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Max-Age': '86400'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    if method == 'POST':
        body = event.get('body', '{}')
        if not body:
            body = '{}'
        body_data = json.loads(body)
        
        personal_data = body_data.get('personalData')
        credit_data = body_data.get('creditData')
        income_data = body_data.get('incomeData')
        property_data = body_data.get('propertyData')
        additional_fields = body_data.get('additionalFields', {})
        doc_format = body_data.get('format', 'docx')
        
        if not personal_data or not credit_data:
            return {
                'statusCode': 400,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'error': 'Недостаточно данных для генерации заявления'}),
                'isBase64Encoded': False
            }
        
        if doc_format == 'pdf':
            pdf_base64 = generate_pdf_document(
                personal_data, credit_data, income_data, property_data, additional_fields
            )
            result = {
                'success': True,
                'document': {
                    'data': pdf_base64,
                    'createdAt': datetime.now().isoformat(),
                    'format': 'pdf',
                    'fileName': f"заявление_банкротство_{personal_data.get('inn', 'doc')}.pdf"
                }
            }
        elif doc_format == 'docx':
            docx_base64 = generate_docx_document(
                personal_data, credit_data, income_data, property_data, additional_fields
            )
            result = {
                'success': True,
                'document': {
                    'data': docx_base64,
                    'createdAt': datetime.now().isoformat(),
                    'format': 'docx',
                    'fileName': f"заявление_банкротство_{personal_data.get('inn', 'doc')}.docx"
                }
            }
        else:
            document_text = generate_bankruptcy_application(
                personal_data, credit_data, income_data, property_data
            )
            result = {
                'success': True,
                'document': {
                    'text': document_text,
                    'createdAt': datetime.now().isoformat(),
                    'format': 'text',
                    'fileName': f"заявление_банкротство_{personal_data.get('inn', 'doc')}.txt"
                }
            }
        
        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps(result),
            'isBase64Encoded': False
        }
    
    return {
        'statusCode': 405,
        'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
        'body': json.dumps({'error': 'Метод не поддерживается'}),
        'isBase64Encoded': False
    }


def format_number(num):
    """Форматирует число с разделителями тысяч"""
    if not num:
        return "0"
    return f"{float(num):,.0f}".replace(',', ' ')


def determine_court_by_address(address: str) -> Dict[str, str]:
    '''Определяет арбитражный суд по адресу регистрации'''
    
    address_lower = address.lower()
    
    courts_mapping = {
        'москва': {
            'name': 'Арбитражный суд города Москвы',
            'address': '115191, г. Москва, ул. Большая Тульская, д. 17'
        },
        'московская область': {
            'name': 'Арбитражный суд Московской области',
            'address': '107053, г. Москва, пр-т Академика Сахарова, д. 18'
        },
        'санкт-петербург': {
            'name': 'Арбитражный суд города Санкт-Петербурга и Ленинградской области',
            'address': '191015, г. Санкт-Петербург, Суворовский пр., д. 50-52'
        },
        'ленинградская область': {
            'name': 'Арбитражный суд города Санкт-Петербурга и Ленинградской области',
            'address': '191015, г. Санкт-Петербург, Суворовский пр., д. 50-52'
        },
        'новосибирск': {
            'name': 'Арбитражный суд Новосибирской области',
            'address': '630102, г. Новосибирск, ул. Нижегородская, д. 6'
        },
        'екатеринбург': {
            'name': 'Арбитражный суд Свердловской области',
            'address': '620075, г. Екатеринбург, ул. Шарташская, д. 4'
        },
        'казань': {
            'name': 'Арбитражный суд Республики Татарстан',
            'address': '420107, г. Казань, ул. Право-Булачная, д. 34/2'
        },
        'нижний новгород': {
            'name': 'Арбитражный суд Нижегородской области',
            'address': '603006, г. Нижний Новгород, Кремль, корп. 4'
        },
        'челябинск': {
            'name': 'Арбитражный суд Челябинской области',
            'address': '454000, г. Челябинск, ул. Воровского, д. 2'
        },
        'омск': {
            'name': 'Арбитражный суд Омской области',
            'address': '644024, г. Омск, ул. Учебная, д. 51'
        },
        'самара': {
            'name': 'Арбитражный суд Самарской области',
            'address': '443045, г. Самара, ул. Авроры, д. 148'
        },
        'ростов': {
            'name': 'Арбитражный суд Ростовской области',
            'address': '344002, г. Ростов-на-Дону, ул. Станиславского, д. 8'
        },
        'уфа': {
            'name': 'Арбитражный суд Республики Башкортостан',
            'address': '450057, г. Уфа, ул. Октябрьской революции, д. 63а'
        },
        'красноярск': {
            'name': 'Арбитражный суд Красноярского края',
            'address': '660049, г. Красноярск, пр. Мира, д. 63'
        },
        'пермь': {
            'name': 'Арбитражный суд Пермского края',
            'address': '614990, г. Пермь, ул. Екатерининская, д. 177'
        },
        'воронеж': {
            'name': 'Арбитражный суд Воронежской области',
            'address': '394030, г. Воронеж, ул. Свободы, д. 45'
        },
        'волгоград': {
            'name': 'Арбитражный суд Волгоградской области',
            'address': '400005, г. Волгоград, ул. Богунская, д. 12'
        },
        'краснодар': {
            'name': 'Арбитражный суд Краснодарского края',
            'address': '350063, г. Краснодар, ул. Постовая, д. 32'
        },
        'саратов': {
            'name': 'Арбитражный суд Саратовской области',
            'address': '410002, г. Саратов, ул. Бабушкин взвоз, д. 1'
        },
        'тюмень': {
            'name': 'Арбитражный суд Тюменской области',
            'address': '625000, г. Тюмень, ул. Первомайская, д. 20'
        },
        'тула': {
            'name': 'Арбитражный суд Тульской области',
            'address': '300041, г. Тула, ул. Староникитская, д. 1'
        },
        'иркутск': {
            'name': 'Арбитражный суд Иркутской области',
            'address': '664025, г. Иркутск, бул. Гагарина, д. 70'
        },
        'владивосток': {
            'name': 'Арбитражный суд Приморского края',
            'address': '690091, г. Владивосток, ул. Светланская, д. 54'
        },
        'хабаровск': {
            'name': 'Арбитражный суд Хабаровского края',
            'address': '680000, г. Хабаровск, ул. Ленина, д. 37'
        },
    }
    
    for region, court in courts_mapping.items():
        if region in address_lower:
            return court
    
    return {
        'name': 'Арбитражный суд (не удалось определить автоматически)',
        'address': 'Укажите адрес суда вручную'
    }


def generate_docx_document(
    personal: Dict[str, Any],
    credit: Dict[str, Any],
    income: Dict[str, Any],
    property: Dict[str, Any],
    additional: Dict[str, Any] = None
) -> str:
    '''Генерирует DOCX документ по шаблону и возвращает base64'''
    
    doc = Document()
    
    if additional is None:
        additional = {}
    
    passport = personal.get('passport', {})
    registration = personal.get('registration', {})
    creditors = credit.get('creditors', [])
    total_debt = credit.get('totalDebt', 0)
    
    registration_address = registration.get('address', '')
    auto_court = determine_court_by_address(registration_address)
    
    court_name = additional.get('courtName', auto_court['name'])
    court_address = additional.get('courtAddress', auto_court['address'])
    phone = additional.get('phone', 'Место для ввода текста.')
    email = additional.get('email', 'Место для ввода текста.')
    
    doc.add_paragraph(f"В {court_name}")
    doc.add_paragraph(f"Адрес: {court_address}")
    doc.add_paragraph()
    
    doc.add_paragraph(f"Заявитель (Должник):")
    doc.add_paragraph(f"{personal.get('fullName', 'Место для ввода текста.')}")
    doc.add_paragraph(f"Адрес: {registration.get('address', 'Место для ввода текста.')}")
    doc.add_paragraph()
    
    doc.add_paragraph(f"Паспорт: серия {passport.get('series', 'Место для ввода текста.')} номер {passport.get('number', 'Место для ввода текста.')}")
    doc.add_paragraph(f"выдан: {passport.get('issuedBy', 'Место для ввода текста.')}")
    doc.add_paragraph(f"дата выдачи: {passport.get('issueDate', 'Место для ввода текста.')}")
    doc.add_paragraph(f"код подразделения: {passport.get('code', 'Место для ввода текста.')}")
    doc.add_paragraph(f"тел. 8 {phone}")
    doc.add_paragraph(f"e-mail: {email}")
    doc.add_paragraph()
    doc.add_paragraph()
    
    doc.add_paragraph("Кредиторы:")
    for idx, creditor in enumerate(creditors[:4], 1):
        doc.add_paragraph(f"{idx}. {creditor.get('name', 'Место для ввода текста.')}")
        doc.add_paragraph(f"ИНН {creditor.get('inn', 'Место для ввода текста.')}")
        doc.add_paragraph(f"Юридический адрес: Место для ввода текста.")
        doc.add_paragraph()
    
    if len(creditors) < 4:
        for i in range(len(creditors) + 1, 5):
            doc.add_paragraph(f"{i}. Место для ввода текста.")
            doc.add_paragraph(f"ИНН Место для ввода текста.")
            doc.add_paragraph(f"Юридический адрес: Место для ввода текста.")
            doc.add_paragraph()
    
    doc.add_paragraph()
    
    title = doc.add_heading("ЗАЯВЛЕНИЕ ГРАЖДАНИНА О ПРИЗНАНИИ БАНКРОТОМ", level=1)
    title.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    doc.add_paragraph(f"{personal.get('fullName', 'ФИО')} (далее – «Должник») обращается в суд с заявлением о признании его банкротом, поскольку имеются обязательства на сумму, превышающую 500 000 рублей и эти обязательства не исполнены Должником в течение трех месяцев с даты, когда они должны были быть исполнены. Кроме того, удовлетворение требований одного кредитора или нескольких кредиторов Должника приведет к невозможности исполнения Должником денежных обязательств в полном объеме перед другими кредиторами.")
    
    doc.add_paragraph(f"По состоянию на дату подачи заявления размер непогашенной задолженности Должника перед Кредиторами, составляет {format_number(total_debt)} рублей ({format_number(total_debt)} рублей 00 копеек) из которых:")
    
    for idx, creditor in enumerate(creditors, 1):
        doc.add_paragraph(f"{idx}. Перед {creditor.get('name', 'Место для ввода текста.')}:")
        credits_list = creditor.get('credits', [])
        if credits_list:
            for credit_item in credits_list:
                contract_num = credit_item.get('contractNumber', 'Место для ввода текста.')
                contract_date = credit_item.get('date', 'Место для ввода текста.')
                debt = credit_item.get('debt', 0)
                amount = credit_item.get('amount', 0)
                doc.add_paragraph(f"- по Кредитному договору № {contract_num} от {contract_date} г. общая сумма задолженности составляет {format_number(debt)} рублей, в том числе сумма основного долга {format_number(amount)} рублей, сумма задолженности по начисленным процентам {format_number(debt - amount)} рублей.")
        else:
            doc.add_paragraph(f"- по Кредитному договору № Место для ввода текста. от Место для ввода текста. г. общая сумма задолженности составляет Место для ввода текста. рублей, в том числе сумма основного долга Место для ввода текста. рублей, сумма задолженности по начисленным процентам Место для ввода текста. рублей.")
    
    monthly_income = income.get('monthlyIncome', 0) if income else 0
    yearly_income = income.get('lastYear', 0) if income else 0
    
    doc.add_paragraph(f"Должник не имеет возможности удовлетворить требования Кредиторов в полном объеме, ввиду того, что объем всех ежемесячных обязательных платежей Должника в пользу Кредиторов (более {format_number(total_debt / 12)} рублей) значительно превышает средний размер заработной платы Должника за последний год, что согласно справки 2 НДФЛ составляет {format_number(monthly_income)} рублей. Такая ситуация возникла в связи с тем, что Должник не рассчитал свои силы и возможности, кредиты приобретались при рождении детей и тратились на семейные нужды, впоследствии Должником была потеряна работа.")
    
    doc.add_paragraph("Должник не имеет дохода и является безработным, о чем свидетельствует справка из Центра занятости населения.")
    doc.add_paragraph("На основании справки № Место для ввода текста. от Место для ввода текста. г. Должник отнесен к категории малоимущих граждан. Кроме того, Должник является матерью одиночкой (инвалидом, пр.).")
    doc.add_paragraph("На иждивении у Должника находится несовершеннолетняя сын / дочь ФИО года рождения, проживающая вместе с Должником.")
    doc.add_paragraph("В соответствии с Соглашением об оплате алиментов на содержание несовершеннолетнего ребенка, удостоверенного нотариусом 01.01.2021 г., заключенного между Должником и матерью несовершеннолетнего сына Должника ФИО, Должник обязался выплачивать в пользу своего несовершеннолетнего сына алименты в размере рублей ежемесячно до достижения сыном восемнадцатилетнего возраста.")
    
    if property and property.get('realEstate'):
        real_estate = property.get('realEstate', [])
        if real_estate:
            item = real_estate[0]
            doc.add_paragraph(f"В собственности Должника находится {item.get('type', 'недвижимость')}, общей площадью Место для ввода текста. с земельным участком площадью Место для ввода текста. кв. м. по адресу: {item.get('address', 'Место для ввода текста.')} являющийся единственным пригодным для постоянного проживания помещением для него и членов его семьи.")
    else:
        doc.add_paragraph("В собственности Должника находится Место для ввода текста., общей площадью Место для ввода текста. с земельным участком площадью Место для ввода текста. кв. м. по адресу: Место для ввода текста. являющийся единственным пригодным для постоянного проживания помещением для него и членов его семьи.")
    
    doc.add_paragraph("Кроме того, в собственности Должника находится автомобиль марки Место для ввода текста. г., идентификационный номер VIN: Место для ввода текста.")
    doc.add_paragraph("Какое-либо другое имущество, на которое может быть обращено взыскание в соответствии с действующим законодательством, у Должника отсутствует.")
    
    doc.add_paragraph('В соответствии с п. 1 ст. 213.3 Федерального закона «О несостоятельности (банкротстве)» №127-ФЗ от 16.10.2002 (далее также – «Закон о банкротстве»), правом на обращение в суд с заявлением о признании гражданина банкротом обладают гражданин, конкурсный кредитор, уполномоченный орган.')
    doc.add_paragraph('Согласно п. 1 с. 213.3 Закона о банкротстве, заявление о признании гражданина банкротом принимается судом при условии, что требования к гражданину составляют не менее чем пятьсот тысяч рублей и указанные требования не исполнены в течение трех месяцев с даты, когда они должны быть исполнены, если иное не предусмотрено Законом о банкротстве.')
    doc.add_paragraph('В соответствии с п. 1 ст. 213.4 Закона о банкротстве, гражданин обязан обратиться в суд с заявлением о признании его банкротом в случае, если удовлетворение требований одного кредитора или нескольких кредиторов приводит к невозможности исполнения гражданином денежных обязательств и (или) обязанности по уплате обязательных платежей в полном объеме перед другими кредиторами и размер таких обязательств и обязанности в совокупности составляет не менее чем пятьсот тысяч рублей.')
    doc.add_paragraph('Согласно п. 2 ст. 213.4 Закона о банкротстве гражданин вправе подать в арбитражный суд заявление о признании его банкротом в случае предвидения банкротства при наличии обстоятельств, очевидно свидетельствующих о том, что он не в состоянии исполнить денежные обязательства и (или) обязанность по уплате обязательных платежей в установленный срок, при этом гражданин отвечает признакам неплатежеспособности и (или) признакам недостаточности имущества.')
    doc.add_paragraph('Согласно п.3 ст.213.6 Закона о банкротстве, под неплатежеспособностью гражданина понимается его неспособность удовлетворить в полном объеме требования кредиторов по денежным обязательствам и (или) исполнить обязанность по уплате обязательных платежей.')
    doc.add_paragraph('Если не доказано иное, гражданин предполагается неплатежеспособным при условии, что имеет место хотя бы одно из следующих обстоятельств:')
    doc.add_paragraph('- гражданин прекратил расчеты с кредиторами, то есть перестал исполнять денежные обязательства и (или) обязанность по уплате обязательных платежей, срок исполнения которых наступил;')
    doc.add_paragraph('- более чем десять процентов совокупного размера денежных обязательств и (или) обязанности по уплате обязательных платежей, которые имеются у гражданина и срок исполнения которых наступил, не исполнены им в течение более чем одного месяца со дня, когда такие обязательства должны быть исполнены;')
    doc.add_paragraph('- размер задолженности гражданина превышает стоимость его имущества, в том числе права требования;')
    doc.add_paragraph('- наличие постановления об окончании исполнительного производства в связи с тем, что у гражданина отсутствует имущество, на которое может быть обращено взыскание.')
    
    doc.add_paragraph("На момент подачи настоящего заявления:")
    doc.add_paragraph('- существуют обстоятельства, очевидно свидетельствующие о том, что Должник не в состоянии исполнить денежные обязательства и (или) обязанность по уплате обязательных платежей в установленный срок;')
    doc.add_paragraph(f"- сумма задолженности Должника перед Кредиторами составляет {format_number(total_debt)} рублей;")
    doc.add_paragraph('- срок, в течение которого Должником не были исполнены обязательства, превышает 3 (три) месяца с момента наступления даты их исполнения.')
    doc.add_paragraph('- размер задолженности Должника перед Кредитором превышает стоимость его имущества, на которое может быть обращено взыскание в соответствии с действующим законодательством (п. 3 ст. 213.25 Закона о банкротстве и ст. 446 ГПК РФ).')
    
    doc.add_paragraph('Должник не привлекался к административной ответственности за мелкое хищение, умышленное уничтожение или повреждение имущества, неправомерные действия при банкротстве, фиктивное или преднамеренное банкротство.')
    doc.add_paragraph('Кроме того, в настоящий момент отсутствуют сведения об известных Должнику уголовных и административных делах в отношении него, а также о наличии неснятой или непогашенной судимости.')
    doc.add_paragraph('Должником в течение трех лет до даты подачи заявления была произведена сделка: по договору купли-продажи № Место для ввода текста. 01.01.2021 года было реализовано автотранспортное средство Место для ввода текста. года выпуска. Денежные средства, полученные от совершения сделки, были уплачены в равных долях кредиторам.')
    doc.add_paragraph('Иные сделки с недвижимым имуществом, ценными бумагами, долями в уставном капитале, транспортными средствами и сделок на сумму свыше трехсот тысяч рублей в течение трех лет до даты подачи настоящего заявления Должником не совершались.')
    doc.add_paragraph('В соответствии с общим смыслом п. 19 Постановления Пленума Верховного Суда РФ № 45 от 13.10.2015 г. «О некоторых вопросах, связанных с введением в действие процедур, применяемых в делах о несостоятельности (банкротстве) граждан» в качестве доказательства наличия у Должника денежных средств, достаточных для погашения расходов по делу о банкротстве, к настоящему заявлению приложен платежный документ об оплате в депозит Арбитражного суда денежных средств в размере 25 000 рублей.')
    doc.add_paragraph('Таким образом, имеются признаки банкротства гражданина-должника, указанные в п. 3 ст. 213.6 Закона о банкротстве и основания для возбуждения судом дела о банкротстве в соответствии со статьями 213.3 и 213.4 Закона о банкротстве.')
    doc.add_paragraph('На основании вышеизложенного, а также руководствуясь ст. ст. 6, 27, 38, 213.3, 213.4 Федерального закона «О несостоятельности (банкротстве)» от 26.10.2002 №127-ФЗ; ст. ст. 223, 224 АПК РФ,')
    
    doc.add_paragraph()
    prosh_heading = doc.add_paragraph("ПРОШУ:")
    prosh_heading.runs[0].bold = True
    
    doc.add_paragraph(f"1) Признать {personal.get('fullName', 'Место для ввода текста.')} несостоятельным (банкротом) и ввести процедуру реализации имущества.")
    doc.add_paragraph("2) Назначить финансового управляющего из числа членов следующих саморегулируемых организаций:")
    doc.add_paragraph('• НПС СОПАУ "Альянс управляющих" (350015, Краснодарский край, г. Краснодар, ул.Северная, д.309);')
    doc.add_paragraph('• Ассоциация арбитражных управляющих "ГАРАНТИЯ" (125167, г Москва, ул Викторенко, д.5, строение 1, эт. 2);')
    doc.add_paragraph('• Ассоциация Арбитражных Управляющих "Содружество" (191124, г Санкт-Петербург, Санкт-Петербург, проспект Суворовский, д. 65, лит. Б, пом. 8-Н43);')
    doc.add_paragraph('• АССОЦИАЦИЯ "МЕЖРЕГИОНАЛЬНАЯ САМОРЕГУЛИРУЕМАЯ ОРГАНИЗАЦИЯ ПРОФЕССИОНАЛЬНЫХ АРБИТРАЖНЫХ УПРАВЛЯЮЩИХ" (109240, г. Москва, Котельническая наб., д.17).')
    
    doc.add_paragraph()
    doc.add_paragraph("Приложения:")
    appendices = [
        "1. Почтовые квитанции о направлении копии настоящего заявления кредиторам, Место для ввода текста. листов.",
        "2. Документ, подтверждающий уплату государственной пошлины Место для ввода текста. лист;",
        "3. Документ, подтверждающий внесение денежных средств на выплату вознаграждения финансовому управляющему в депозит арбитражного суда Место для ввода текста. лист;",
        "4. Копия паспорта (всех страниц) Место для ввода текста. листов;",
        "5. Копия ИНН (свидетельства о постановке на учет в налоговом органе) (при наличии) Место для ввода текста. лист;",
        "6. Копия СНИЛС Место для ввода текста. лист;",
        "7. Копии справок, выданных кредиторами о задолженности на Место для ввода текста. листах;",
        "8. Копии кредитных договоров Место для ввода текста. штуки;",
        "9. Документы, подтверждающие наличие или отсутствие у гражданина статуса индивидуального предпринимателя, полученные не ранее чем за пять рабочих дней до даты подачи в суд заявления на Место для ввода текста. листе;",
        "10. Список кредиторов и должников гражданина по форме Приложения № 1 к Приказу Минэкономразвития России от 05.08.2015 № 530;",
        "11. Опись имущества гражданина по форме Приложения № 2 к Приказу Минэкономразвития России от 05.08.2015 № 530;",
        "12. Справки 2 НДФЛ за трехлетний период, предшествующий дате подачи заявления о признании гражданина банкротом на Место для ввода текста. листах;",
        "13. Копии документов, подтверждающих право собственности гражданина на имущество на Место для ввода текста. листах (при наличии);",
        "14. Копии документов о совершавшихся гражданином в течение трех лет до даты подачи заявления сделках с недвижимым имуществом, транспортными средствами и сделках на сумму свыше трехсот тысяч рублей (при наличии);",
        "15. Копия свидетельства пенсионного страхования (при наличии);",
        "16. Копия решения о признании гражданина безработным, выданная государственной службой занятости населения (при наличии);",
        "17. Копия свидетельства о заключении брака (при наличии заключенного и не расторгнутого на дату подачи заявления брака);",
        "18. Копия свидетельства о расторжении брака, если оно выдано в течение трех лет до даты подачи заявления (при наличии);",
        "19. Копия брачного договора (при наличии);",
        "20. Копия соглашения или судебного акта о разделе общего имущества супругов, соответственно заключенного и принятого в течение трех лет до даты подачи заявления (при наличии);",
        "21. Копия свидетельства о рождении ребенка, если гражданин является его родителем, усыновителем или опекуном.",
    ]
    
    for creditor_idx in range(len(creditors)):
        appendices.append(f"{22 + creditor_idx}. Выписка из ЕГРЮЛ на кредитора {creditor_idx + 1};")
    
    for app in appendices:
        doc.add_paragraph(app)
    
    doc.add_paragraph()
    doc.add_paragraph(f"Должник: {personal.get('fullName', 'Место для ввода текста.')}")
    doc.add_paragraph(f"Дата: {datetime.now().strftime('%d.%m.%Y')}")
    
    buffer = io.BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    return base64.b64encode(buffer.read()).decode('utf-8')


def generate_pdf_document(
    personal: Dict[str, Any],
    credit: Dict[str, Any],
    income: Dict[str, Any],
    property: Dict[str, Any],
    additional: Dict[str, Any] = None
) -> str:
    '''Генерирует PDF документ по шаблону и возвращает base64'''
    
    buffer = io.BytesIO()
    c = canvas.Canvas(buffer, pagesize=A4)
    width, height = A4
    
    y = height - 2*cm
    
    c.setFont("Helvetica", 10)
    
    if additional is None:
        additional = {}
    
    passport = personal.get('passport', {})
    registration = personal.get('registration', {})
    creditors = credit.get('creditors', [])
    total_debt = credit.get('totalDebt', 0)
    
    registration_address = registration.get('address', '')
    auto_court = determine_court_by_address(registration_address)
    
    court_name = additional.get('courtName', auto_court['name'])
    court_address = additional.get('courtAddress', auto_court['address'])
    phone = additional.get('phone', 'Место для ввода текста.')
    email = additional.get('email', 'Место для ввода текста.')
    
    c.drawString(2*cm, y, f"В {court_name}")
    y -= 0.5*cm
    c.drawString(2*cm, y, f"Адрес: {court_address}")
    y -= 1*cm
    
    c.drawString(2*cm, y, f"Заявитель (Должник):")
    y -= 0.5*cm
    c.drawString(2*cm, y, f"{personal.get('fullName', 'Место для ввода текста.')}")
    y -= 0.5*cm
    c.drawString(2*cm, y, f"Адрес: {registration.get('address', 'Место для ввода текста.')}")
    y -= 1*cm
    
    c.drawString(2*cm, y, f"Паспорт: серия {passport.get('series', 'Место для ввода текста.')} номер {passport.get('number', 'Место для ввода текста.')}")
    y -= 0.5*cm
    c.drawString(2*cm, y, f"выдан: {passport.get('issuedBy', 'Место для ввода текста.')}")
    y -= 0.5*cm
    c.drawString(2*cm, y, f"дата выдачи: {passport.get('issueDate', 'Место для ввода текста.')}")
    y -= 0.5*cm
    c.drawString(2*cm, y, f"код подразделения: {passport.get('code', 'Место для ввода текста.')}")
    y -= 1*cm
    
    c.drawString(2*cm, y, "Кредиторы:")
    y -= 0.5*cm
    
    for idx, creditor in enumerate(creditors[:4], 1):
        c.drawString(2*cm, y, f"{idx}. {creditor.get('name', 'Место для ввода текста.')}")
        y -= 0.5*cm
        c.drawString(2*cm, y, f"ИНН {creditor.get('inn', 'Место для ввода текста.')}")
        y -= 0.5*cm
        c.drawString(2*cm, y, f"Юридический адрес: Место для ввода текста.")
        y -= 0.7*cm
        
        if y < 5*cm:
            c.showPage()
            y = height - 2*cm
            c.setFont("Helvetica", 10)
    
    y -= 1*cm
    c.setFont("Helvetica-Bold", 12)
    c.drawCentredString(width/2, y, "ЗАЯВЛЕНИЕ ГРАЖДАНИНА О ПРИЗНАНИИ БАНКРОТОМ")
    y -= 1.5*cm
    
    c.setFont("Helvetica", 10)
    
    text_lines = [
        f"{personal.get('fullName', 'ФИО')} (далее – «Должник») обращается в суд с заявлением",
        "о признании его банкротом, поскольку имеются обязательства на сумму,",
        "превышающую 500 000 рублей...",
        "",
        f"Общая задолженность: {format_number(total_debt)} рублей",
    ]
    
    for line in text_lines:
        if y < 3*cm:
            c.showPage()
            y = height - 2*cm
            c.setFont("Helvetica", 10)
        c.drawString(2*cm, y, line)
        y -= 0.5*cm
    
    y -= 1*cm
    c.setFont("Helvetica-Bold", 10)
    c.drawString(2*cm, y, "ПРОШУ:")
    y -= 0.7*cm
    
    c.setFont("Helvetica", 10)
    c.drawString(2*cm, y, f"1) Признать {personal.get('fullName', 'Место для ввода текста.')} несостоятельным (банкротом)")
    y -= 0.5*cm
    c.drawString(2*cm, y, "2) Назначить финансового управляющего")
    y -= 1.5*cm
    
    c.drawString(2*cm, y, f"Должник: {personal.get('fullName', 'Место для ввода текста.')}")
    y -= 0.7*cm
    c.drawString(2*cm, y, f"Дата: {datetime.now().strftime('%d.%m.%Y')}")
    
    c.save()
    buffer.seek(0)
    return base64.b64encode(buffer.read()).decode('utf-8')


def generate_bankruptcy_application(
    personal: Dict[str, Any],
    credit: Dict[str, Any],
    income: Dict[str, Any],
    property: Dict[str, Any]
) -> str:
    '''Генерирует текст заявления о банкротстве (устарело, используйте DOCX/PDF)'''
    return "Используйте формат DOCX или PDF для генерации документа"